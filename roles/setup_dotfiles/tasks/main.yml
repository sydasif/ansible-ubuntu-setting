---
- name: Ensure parent directories for config files exist
  ansible.builtin.file:
    path: "{{ dotfiles_base_dest }}/{{ item.dest_suffix | dirname }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"
  loop: "{{ dotfiles_items | rejectattr('src', 'equalto', 'dotfiles/.gitconfig') }}"
  when: item.dest_suffix | dirname != '.'

- name: Copy dotfiles and config files
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ dotfiles_base_dest }}/{{ item.dest_suffix }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  loop: "{{ dotfiles_items | rejectattr('src', 'equalto', 'dotfiles/.gitconfig') }}"

- name: Template .gitconfig from variables
  ansible.builtin.template:
    src: .gitconfig.j2
    dest: "{{ dotfiles_base_dest }}/.gitconfig"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Check if Dracula vim theme is already installed
  ansible.builtin.stat:
    path: "{{ dotfiles_base_dest }}/.vim/pack/themes/start/dracula"
  register: dracula_vim_theme_status

- name: Install Dracula vim theme
  ansible.builtin.git:
    repo: "https://github.com/dracula/vim.git"
    dest: "{{ dotfiles_base_dest }}/.vim/pack/themes/start/dracula"
  become_user: "{{ ansible_user }}"
  when: not dracula_vim_theme_status.stat.exists
